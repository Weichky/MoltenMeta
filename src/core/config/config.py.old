from typing import Dict, Any
from pathlib import Path

from catalog import DatabaseType

from core.platform import getRuntimePath

_config: Dict[str, Any] | None = None

def loadConfig() -> None:
    global _config

    _config = _loadConfig()

def getConfigs() -> Dict[str, Any]:
    global _config

    if _config is None:
        loadConfig()

    return _config

def getConfig(key: str) -> Any:
    global _config

    if _config is None:
        loadConfig()
    
    try:
        return _config[key]
    except KeyError:
        raise RuntimeError(f"Config key {key} not found")
    
def setConfig(key: str, value: Any):
    global _config

    if _config is None:
        raise RuntimeError("Config system not initialized")
    
    _config[key] = value

# Waiting to be moved to the query module.
def getLanguage() -> str:
    return getConfig("locale")["language"]

def setLanguage(language: str):
    setConfig("locale", {"language": language})

def getLogLevel() -> str:
    return getConfig("log")["level"]

def getThemeName() -> str:
    return getConfig("locale")["scheme"] + "_" + getConfig("locale")["theme"]

def getThemeXML() -> str:
    return getThemeName() + ".xml"

def getScheme() -> str:
    return getConfig("locale")["scheme"]

def getDatabaseType() -> DatabaseType:
    _db_type = getConfig("database")["db_type"]

    try:
        return DatabaseType(_db_type.lower())
    except ValueError:
        raise RuntimeError(f"Invalid database type {_db_type}")
    
def getDatabaseTypeName() -> str:
    return getDatabaseType().value

def getDatabaseFileDir() -> Path:
    return getRuntimePath() /  getConfig("database")["file_path"]

def getDatabaseFileName() -> str:
    return getConfig("database")["file_name"]

def getDatabaseFilePath() -> Path:
    return getDatabaseFileDir() / getDatabaseFileName()